Directory structure:
└── src/
    ├── Favorites/
    │   └── page.js
    ├── app/
    │   ├── config.js
    │   ├── globals.css
    │   ├── layout.js
    │   ├── page.js
    │   ├── admin/
    │   │   └── page.js
    │   ├── api/
    │   │   └── v1/
    │   │       ├── [...path]/
    │   │       │   └── route.ts
    │   │       └── verification/
    │   │           └── request/
    │   │               └── route.ts
    │   ├── auth/
    │   │   ├── error/
    │   │   │   └── page.js
    │   │   ├── launch/
    │   │   │   └── page.js
    │   │   ├── login/
    │   │   │   └── page.js
    │   │   ├── onboarding/
    │   │   │   └── page.js
    │   │   ├── otp/
    │   │   │   └── page.js
    │   │   ├── sign-up/
    │   │   │   └── page.js
    │   │   ├── success/
    │   │   │   └── page.js
    │   │   └── verify/
    │   │       ├── id-upload/
    │   │       │   └── page.js
    │   │       └── otp/
    │   │           └── page.js
    │   ├── browse/
    │   │   └── page.js
    │   ├── chat/
    │   │   └── page.js
    │   ├── components/
    │   │   ├── Button.js
    │   │   ├── Card.js
    │   │   ├── CategoryTabs.js
    │   │   ├── ChatConversation.js
    │   │   ├── ChatList.js
    │   │   ├── Checkbox.js
    │   │   ├── EmptyState.js
    │   │   ├── ImageCarousel.js
    │   │   ├── ImageUpload.js
    │   │   ├── Input.js
    │   │   ├── ListingCard.js
    │   │   ├── ListingGrid.js
    │   │   ├── Pagination.js
    │   │   ├── ProductDetails.js
    │   │   ├── ReconnectBanner.js
    │   │   ├── SearchBar.js
    │   │   ├── Select.js
    │   │   ├── SellerLink.js
    │   │   ├── Skeleton.js
    │   │   ├── SkeletonCard.js
    │   │   ├── Spinner.js
    │   │   ├── Textarea.js
    │   │   ├── TopNav.js
    │   │   └── Typography.js
    │   ├── create-listing/
    │   │   └── page.js
    │   ├── favorites/
    │   │   └── page.js
    │   ├── listing/
    │   │   └── [id]/
    │   │       └── page.js
    │   ├── my-listings/
    │   │   └── page.js
    │   ├── notifications/
    │   │   └── page.js
    │   ├── profile/
    │   │   └── page.js
    │   └── ui/
    │       └── page.js
    ├── lib/
    │   ├── api.ts
    │   └── chat.js
    └── utils/
        └── format.js

================================================
File: Favorites/page.js
================================================
// src/app/favorites/page.js
import React from 'react';
import Favorites from '@/app/components/listings/Favorites';

const FavoritesPage = () => (
  <div className="container mx-auto p-4">
    <Favorites />
  </div>
);

export default FavoritesPage;


================================================
File: app/config.js
================================================
// File: src/app/config.js
// app/config.js
export const FEATURE_FLAGS = {
  enableWebSocket: true, // Toggle for WebSocket vs. mock data
};


================================================
File: app/globals.css
================================================
/* File: uni-market/src/app/globals.css */
@import "tailwindcss";

:root {
  --primary: #2563eb;
  --secondary: #6b7280;
  --destructive: #dc2626;
  --background: #f9fafb;
  --foreground: #111827;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --primary: #3b82f6;
    --secondary: #9ca3af;
    --destructive: #ef4444;
    --background: #1f2937;
    --foreground: #f3f4f6;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


================================================
File: app/layout.js
================================================
// File: src/app/layout.js
import './globals.css';
import { Inter } from 'next/font/google';
import TopNav from './components/TopNav'; // ← client nav

const inter = Inter({ subsets: ['latin'] });

export const metadata = {
  title: 'University Marketplace',
  description: 'A platform for university students to buy and sell items',
  manifest: '/manifest.json',   // ✅ PWA support
  themeColor: '#2980B9',        // ✅ install bar color
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={`${inter.className} bg-gray-50 text-gray-900 dark:bg-gray-900 flex flex-col min-h-screen`}>
        {/* Header (client-side auth awareness) */}
        <TopNav />

        {/* Main content */}
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
          {children}
        </main>

        {/* Footer */}
        <footer className="bg-white dark:bg-gray-800 shadow-t mt-auto">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <p className="text-sm text-gray-500 dark:text-gray-400">
              &copy; {new Date().getFullYear()} University Marketplace. All rights reserved.
            </p>
          </div>
        </footer>
      </body>
    </html>
  );
}



================================================
File: app/page.js
================================================
// File: src/app/page.js
import { Button } from './components/Button';

export default function Home() {
  return (
    <div className="text-center space-y-6 py-12">
      <h1 className="text-4xl font-bold tracking-tight text-gray-900 dark:text-gray-100">
        Welcome to University Marketplace
      </h1>
      <p className="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Buy and sell items within your university community. Find textbooks, electronics, furniture, and more at great prices!
      </p>
      <div className="space-x-4">
        <Button variant="primary" href="/browse">
          Start Browsing
        </Button>
        <Button variant="secondary" href="/create-listing">
          Create a Listing
        </Button>
      </div>
      <p className="text-sm text-gray-500 dark:text-gray-400 mt-6">
        Returning user? Check your <a href="/my-listings" className="underline">My Listings</a> or <a href="/favorites" className="underline">Favorites</a>.
      </p>
    </div>
  );
}


================================================
File: app/admin/page.js
================================================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { apiFetch } from '@/lib/api';

export default function AdminPage() {
  const router = useRouter();

  const [email, setEmail] = useState('');
  const [studentId, setStudentId] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState('');
  const [needLogin, setNeedLogin] = useState(false);

  useEffect(() => {
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (!token) { setNeedLogin(true); return; }

    (async () => {
      try {
        const me = await apiFetch('/auth/me');
        if (me?.email) setEmail(me.email);

        // âœ… If already verified â†’ redirect away
        if (me?.is_verified) {
          router.replace('/browse');
        }
      } catch {
        setNeedLogin(true);
      }
    })();
  }, [router]);

  async function handleRequest(e) {
    e.preventDefault();
    setMsg('');
    setSubmitting(true);

    // (kept from your original file)
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    const tokenType = typeof window !== 'undefined'
      ? (localStorage.getItem('token_type') || 'JWT')
      : 'JWT';

    if (!token) { setNeedLogin(true); setSubmitting(false); return; }

    // helper: long-timeout local fetch fallback (works even if apiFetch times out)
    const postWithLongerTimeout = async () => {
      const url = `${window.location.origin}/api/v1/verification/request`;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 300000); // 5 min
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `${tokenType} ${token}`,
          },
          body: JSON.stringify({
            university_email: email,
            student_id: studentId,
          }),
          signal: controller.signal,
          cache: 'no-store',
        });
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(text || `${res.status} ${res.statusText}`);
        }
      } finally {
        clearTimeout(timer);
      }
    };

    try {
      // First try through apiFetch. If your api.ts supports `timeoutMs`,
      // this gives it more headroom; if not, itâ€™s ignored harmlessly.
      await apiFetch('/verification/request', {
        method: 'POST',
        body: JSON.stringify({
          university_email: email,
          student_id: studentId,
        }),
        // longer headroom for slow backend; ignored if api.ts doesnâ€™t read it
        timeoutMs: 300000,
      });

      setMsg('Request submitted. Check your email for the OTP. Redirectingâ€¦');
      setTimeout(() => router.push('/auth/verify/otp'), 600);
    } catch (e) {
      const m = String(e?.message || '');

      if (/aborted/i.test(m)) {
        // Treat client timeout as soft-success and also attempt a direct retry with longer timeout.
        try {
          await postWithLongerTimeout();
          setMsg('Request sent. If you receive the OTP, continue. Redirectingâ€¦');
          setTimeout(() => router.push('/auth/verify/otp'), 600);
          return;
        } catch (e2) {
          // fall through to show whichever error we got
          setMsg(String(e2?.message || m) || 'Request failed.');
        }
      } else if (m.includes('401') || m.includes('403') || /not authenticated/i.test(m)) {
        setNeedLogin(true);
        setMsg('Session expired. Please log in again.');
      } else {
        setMsg(m || 'Request failed.');
      }
    } finally {
      setSubmitting(false);
    }
  }

  if (needLogin) {
    return (
      <p className="text-center text-gray-500">
        Please <Link className="underline" href="/auth/login">log in</Link> to request verification access.
      </p>
    );
  }

  return (
    <div className="max-w-xl mx-auto space-y-6">
      <h1 className="text-2xl font-bold">Request Verification / Access</h1>

      <form onSubmit={handleRequest} className="space-y-4">
        <div>
          <label className="block text-sm font-medium">University Email</label>
          <input
            type="email"
            className="w-full rounded px-3 py-2 bg-gray-800 text-white"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium">Student ID</label>
          <input
            type="text"
            className="w-full rounded px-3 py-2 bg-gray-800 text-white"
            value={studentId}
            onChange={(e) => setStudentId(e.target.value)}
            required
          />
        </div>

        <button
          type="submit"
          disabled={submitting}
          className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-60 rounded px-4 py-3 font-semibold"
        >
          {submitting ? 'Sendingâ€¦' : 'Send Request'}
        </button>
      </form>

      {msg && (
        <p className={`text-center ${/redirect|submitted|otp/i.test(msg) ? 'text-green-500' : 'text-red-500'}`}>
          {msg}
        </p>
      )}
    </div>
  );
}



================================================
File: app/api/v1/[...path]/route.ts
================================================
// File: src/app/api/v1/[...path]/route.ts
export const runtime = 'nodejs';

const BACKEND = 'https://campus-exchange-fastapi-production.up.railway.app';

type Ctx = { params: Promise<{ path: string[] }> }; // <- params are async in your setup

function join(base: string, path: string) {
  const b = base.replace(/\/+$/, '');
  const p = path.startsWith('/') ? path : `/${path}`;
  return `${b}${p}`;
}

function buildPath(parts: string[]) {
  // Swagger shows /api/v1/verification/request (no final slash)
  return `/api/v1/${(parts ?? []).join('/')}`;
}

async function forward(req: Request, parts: string[]) {
  const path = buildPath(parts);
  const targetUrl = new URL(join(BACKEND, path));

  // preserve query
  const here = new URL(req.url);
  if (here.search) targetUrl.search = here.search;

  // clone headers & drop hop-by-hop
  const headers = new Headers(req.headers);
  headers.delete('host');
  headers.delete('connection');
  headers.delete('content-length');
  headers.delete('transfer-encoding');

  const withBody = ['POST', 'PUT', 'PATCH', 'DELETE'];
  const init: RequestInit = {
    method: req.method,
    headers,
    redirect: 'follow',
    cache: 'no-store',
  };

  if (withBody.includes(req.method)) {
    // buffer the incoming body → avoids Node fetch “duplex” error
    const ab = await req.arrayBuffer();
    (init as any).body = Buffer.from(ab);
  }

  let upstream: Response;
  try {
    upstream = await fetch(targetUrl.toString(), init);
  } catch (err: any) {
    const msg = typeof err?.message === 'string' ? err.message : 'fetch to backend failed';
    return new Response(
      JSON.stringify({ detail: `Proxy error to ${targetUrl}: ${msg}` }),
      { status: 502, headers: { 'content-type': 'application/json', 'cache-control': 'no-store' } }
    );
  }

  if (!upstream.ok) {
    const text = await upstream.text().catch(() => '');
    const out = text || JSON.stringify({ detail: `${upstream.status} ${upstream.statusText}` });
    return new Response(out, {
      status: upstream.status,
      headers: { 'content-type': 'application/json', 'cache-control': 'no-store' },
    });
  }

  const outHeaders = new Headers(upstream.headers);
  outHeaders.delete('transfer-encoding');
  outHeaders.delete('connection');
  outHeaders.delete('access-control-allow-origin');
  outHeaders.delete('access-control-allow-credentials');

  return new Response(upstream.body, {
    status: upstream.status,
    statusText: upstream.statusText,
    headers: outHeaders,
  });
}

export async function GET(req: Request, ctx: Ctx)    { const { path } = await ctx.params; return forward(req, path); }
export async function POST(req: Request, ctx: Ctx)   { const { path } = await ctx.params; return forward(req, path); }
export async function PUT(req: Request, ctx: Ctx)    { const { path } = await ctx.params; return forward(req, path); }
export async function PATCH(req: Request, ctx: Ctx)  { const { path } = await ctx.params; return forward(req, path); }
export async function DELETE(req: Request, ctx: Ctx) { const { path } = await ctx.params; return forward(req, path); }

export async function OPTIONS() {
  return new Response(null, { status: 204, headers: { 'cache-control': 'no-store' } });
}



================================================
File: app/api/v1/verification/request/route.ts
================================================
export const runtime = 'edge'; // use Edge runtime to avoid Node/undici TLS quirks

const BACKEND = 'https://campus-exchange-fastapi-production.up.railway.app';
const TARGET = `${BACKEND}/api/v1/verification/request`;

function cleanHeaders(h: Headers) {
  const out = new Headers(h);
  out.delete('host');
  out.delete('connection');
  out.delete('content-length');
  out.delete('transfer-encoding');
  return out;
}

export async function POST(req: Request) {
  const inHeaders = cleanHeaders(req.headers);
  const ct = inHeaders.get('content-type') || '';

  // Build body according to content type (donâ€™t set content-type for FormData!)
  let body: BodyInit | null = null;

  try {
    if (ct.includes('application/json')) {
      const json = await req.json();
      body = JSON.stringify(json);
      inHeaders.set('content-type', 'application/json');
    } else if (ct.includes('multipart/form-data')) {
      const form = await req.formData();
      body = form;
      inHeaders.delete('content-type'); // let boundary be set automatically
    } else {
      const ab = await req.arrayBuffer();
      body = ab;
    }
  } catch {
    // if parsing fails just stream raw
    const ab = await req.arrayBuffer();
    body = ab;
  }

  try {
    const res = await fetch(TARGET, {
      method: 'POST',
      headers: inHeaders,
      body,
      redirect: 'follow',
      // Edge runtime has its own timeouts; client still has your api.ts timeout
    });

    const outHeaders = new Headers(res.headers);
    outHeaders.delete('transfer-encoding');
    outHeaders.delete('connection');
    outHeaders.delete('access-control-allow-origin');
    outHeaders.delete('access-control-allow-credentials');

    return new Response(res.body, {
      status: res.status,
      statusText: res.statusText,
      headers: outHeaders,
    });
  } catch (e: any) {
    const detail = e?.message || 'fetch failed';
    return new Response(
      JSON.stringify({ detail: `Proxy error to ${TARGET}: ${detail}` }),
      { status: 502, headers: { 'content-type': 'application/json', 'cache-control': 'no-store' } },
    );
  }
}



================================================
File: app/auth/error/page.js
================================================
import { Button } from '../../components/Button';
import { Card } from '../../components/Card';
import Link from 'next/link';

export default function Error() {
  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full text-center">
        <h2 className="text-2xl font-bold mb-4 text-red-600 dark:text-red-400">Verification Failed</h2>
        <p className="text-gray-600 dark:text-gray-400 mb-6">
          Something went wrong during verification. Please try again or contact support.
        </p>
        <Button variant="primary" as="a" href="/auth/verify/otp" className="w-full">
          Try Again
        </Button>
      </Card>
    </div>
  );
}


================================================
File: app/auth/launch/page.js
================================================
import Link from 'next/link';
import { Button } from '../../components/Button';
import { Card } from '../../components/Card';

export default function Launch() {
  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full">
        <h2 className="text-2xl font-bold mb-4 text-center">
          Welcome to Your University Marketplace
        </h2>
        <p className="text-gray-600 dark:text-gray-400 mb-6 text-center">
          Join our community to buy and sell items with fellow students. Lets get started!
        </p>
        <div className="space-y-4">
          <Button variant="primary" href="/auth/onboarding" className="w-full">
            Start Onboarding
          </Button>
          <p className="text-sm text-gray-500 dark:text-gray-400 text-center">
            Already have an account?{' '}
            <Link
              href="/auth/login"
              className="text-blue-600 dark:text-blue-400 hover:underline"
            >
              Log in
            </Link>
          </p>
        </div>
      </Card>
    </div>
  );
}


================================================
File: app/auth/login/page.js
================================================
"use client";
import { useState } from "react";
import Link from "next/link";
import { Button } from "../../components/Button";
import { Card } from "../../components/Card";
import { apiFetch } from "@/lib/api";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  async function handleSubmit(e) {
    e.preventDefault();
    if (loading) return;
    setError("");
    setLoading(true);

    try {
      const loginPaths = ["/auth/login", "/auth/sign-in"];
      let data = null, lastErr = null;

      for (const path of loginPaths) {
        try {
          data = await apiFetch(path, {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });
          lastErr = null;
          break;
        } catch (err) {
          lastErr = err;
          if (!String(err?.message).includes("404")) throw err;
        }
      }
      if (lastErr) throw lastErr;

      const token =
        data?.access_token || data?.accessToken || data?.token || null;

      // your backend uses JWT scheme
      const tokenType = data?.token_type || data?.tokenType || "JWT";

      if (!token) throw new Error("No access token returned from server");

      localStorage.setItem("token", token);
      localStorage.setItem("token_type", tokenType);

      window.location.href = "/browse";
    } catch (err) {
      setError(String(err?.message || "Login failed"));
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full p-6">
        <h2 className="text-2xl font-bold mb-4 text-center">Log In</h2>
        {error && <div className="bg-red-600 text-white px-3 py-2 rounded mb-4">{error}</div>}
        <form onSubmit={handleSubmit} className="space-y-4">
          <input className="w-full rounded px-3 py-2 bg-gray-800 text-white" type="email"
                 placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required />
          <input className="w-full rounded px-3 py-2 bg-gray-800 text-white" type="password"
                 placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} required />
          <Button type="submit" variant="primary" className="w-full" disabled={loading}>
            {loading ? "Logging in..." : "Log In"}
          </Button>
        </form>
        <p className="text-sm text-gray-400 mt-4 text-center">
          Donâ€™t have an account? <Link href="/auth/sign-up" className="underline">Sign up</Link>
        </p>
      </Card>
    </div>
  );
}



================================================
File: app/auth/onboarding/page.js
================================================
// File: src/app/auth/onboarding/page.js
import Link from 'next/link';
import { Button } from '../../components/Button';
import { Card } from '../../components/Card';

export default function Onboarding() {
  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full">
        <h2 className="text-2xl font-bold mb-4 text-center">Onboarding</h2>

        <div className="text-gray-600 dark:text-gray-400 mb-6">
          <p>Welcome to the University Marketplace! Here, you can:</p>
          <ul className="list-disc pl-5 mt-2 space-y-1">
            <li>Buy textbooks, electronics, and more at student-friendly prices.</li>
            <li>Sell items you no longer need to fellow students.</li>
            <li>Connect with your university community securely.</li>
          </ul>
        </div>

        <div className="space-y-4">
          <Button variant="primary" href="/auth/sign-up" className="w-full">
            Create an Account
          </Button>
          <p className="text-sm text-gray-500 dark:text-gray-400 text-center">
            Already have an account?{' '}
            <Link href="/auth/login" className="text-blue-600 dark:text-blue-400 hover:underline">
              Log in
            </Link>
          </p>
        </div>
      </Card>
    </div>
  );
}


================================================
File: app/auth/otp/page.js
================================================
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { useRouter } from 'next/navigation';
import { Button } from '../../components/Button';
import { Input } from '../../components/Input';
import { Card } from '../../components/Card';
import { Spinner } from '../../components/Spinner';
import { apiFetch } from '@/lib/api';

export default function OTPVerification() {
  const router = useRouter();
  const { register, handleSubmit, formState: { errors } } = useForm();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const onSubmit = async (data) => {
    setIsLoading(true);
    setError(null);
    try {
      // POST /api/v1/verification/verify-otp  (auth required)
      await apiFetch('/verification/verify-otp', {
        method: 'POST',
        body: JSON.stringify({ otp_code: data.otp }),
      });
      router.push('/auth/verify/id-upload');
    } catch (e) {
      setError(e?.message || 'Invalid OTP');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full">
        <h2 className="text-2xl font-bold mb-4 text-center">Verify Your Email</h2>
        <p className="text-gray-600 dark:text-gray-400 mb-6 text-center">
          Enter the 6-digit OTP sent to your email.
        </p>
        {error && <p className="text-red-500 text-sm mb-4 text-center">{error}</p>}
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <Input
            label="OTP"
            inputMode="numeric"
            {...register('otp', {
              required: 'OTP is required',
              pattern: { value: /^\d{6}$/, message: 'OTP must be 6 digits' },
            })}
            error={errors.otp?.message}
          />
          <Button variant="primary" type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? <Spinner className="w-5 h-5 mx-auto" /> : 'Verify OTP'}
          </Button>
        </form>
      </Card>
    </div>
  );
}



================================================
File: app/auth/sign-up/page.js
================================================
'use client';

import { Spinner } from '../../components/Spinner';
import { motion } from 'framer-motion';
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { Button } from '../../components/Button';
import { Input } from '../../components/Input';
import { Card } from '../../components/Card';
import Link from 'next/link';
import { apiFetch } from '@/lib/api';   // ← use the proxy-aware helper

export default function SignUp() {
  const { register, handleSubmit, formState: { errors } } = useForm();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);


  // Try common endpoint variants so we match your backend without guessing
  const signUpPaths = ['/auth/signup', '/auth/register', '/auth/sign-up'];

  const onSubmit = async ({ email, password }) => {
    setIsLoading(true);
    setError(null);

    try {
      let data = null;
      let lastErr = null;

      const signUpPaths = ['/auth/signup', '/auth/register', '/auth/sign-up'];

      for (const path of signUpPaths) {
        try {
          data = await apiFetch(path, {
            method: 'POST',
            body: JSON.stringify({ email, password }),
          });
          lastErr = null;
          break;
        } catch (e) {
          lastErr = e;
          // if 404, try next path; if other error, rethrow
          if (!String(e?.message).includes('404')) throw e;
        }
      }

      if (lastErr) throw lastErr;

      if (data?.access_token) {
        localStorage.setItem('token', data.access_token);
        window.location.href = '/browse';
      } else {
        window.location.href = '/auth/login';
      }
    } catch (err) {
      setError(err?.message || 'Failed to fetch');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="relative flex items-center justify-center min-h-[calc(100vh-200px)] px-4 overflow-hidden">
      <div className="absolute inset-0 animate-gradient bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900" />

      <motion.div
        className="pointer-events-none absolute -top-24 -left-24 w-[26rem] h-[26rem] rounded-full bg-white/20 blur-3xl"
        animate={{ y: [0, 25, 0], x: [0, 20, 0] }}
        transition={{ duration: 12, repeat: Infinity, ease: 'easeInOut' }}
      />
      <motion.div
        className="pointer-events-none absolute -bottom-28 -right-28 w-[30rem] h-[30rem] rounded-full bg-blue-400/25 blur-3xl"
        animate={{ y: [0, -30, 0], x: [0, -25, 0] }}
        transition={{ duration: 14, repeat: Infinity, ease: 'easeInOut' }}
      />

      <motion.div
        initial={{ opacity: 0, y: 40, scale: 0.98 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
        className="relative z-10 w-full max-w-md"
      >
        <Card className="p-6 md:p-8 rounded-2xl shadow-xl bg-white/80 dark:bg-white/10 backdrop-blur-xl border border-white/30">
          <motion.h2 initial={{ opacity: 0, y: -12 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }}
            className="text-3xl md:text-4xl font-extrabold text-center tracking-tight text-blue-900 dark:text-white">
            Create Account
          </motion.h2>

          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}
            className="mt-2 text-center text-blue-900/70 dark:text-white/80 italic">
            Join us today, it’s free
          </motion.p>

          {error && (
            <motion.p initial={{ opacity: 0, y: -6 }} animate={{ opacity: 1, y: 0 }}
              className="mt-4 bg-blue-50 text-blue-800 p-3 rounded-md text-sm border border-blue-200">
              {error}
            </motion.p>
          )}

          <form onSubmit={handleSubmit(onSubmit)} className="mt-6 space-y-5">
            <motion.div initial={{ opacity: 0, x: -12 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 }}>
              <Input
                label="Email"
                type="email"
                className="bg-white/70 dark:bg-white/20 border border-blue-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 rounded-lg"
                {...register('email', {
                  required: 'Email is required',
                  pattern: { value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, message: 'Invalid email address' },
                })}
                error={errors.email?.message}
              />
            </motion.div>

            <motion.div initial={{ opacity: 0, x: 12 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.35 }}>
              <Input
                label="Password"
                type="password"
                className="bg-white/70 dark:bg-white/20 border border-blue-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 rounded-lg"
                {...register('password', { required: 'Password is required', minLength: { value: 6, message: 'Password must be at least 6 characters' } })}
                error={errors.password?.message}
              />
            </motion.div>

            <motion.div initial={{ opacity: 0, scale: 0.98 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 0.45 }}>
              <Button variant="primary" type="submit" className="w-full py-3 rounded-lg text-lg font-semibold bg-blue-600 hover:bg-blue-700 transition-all" disabled={isLoading}>
                {isLoading ? <Spinner className="w-5 h-5 mx-auto" /> : 'Sign Up'}
              </Button>
            </motion.div>
          </form>

          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.55 }}
            className="text-sm text-blue-900/70 dark:text-white/80 text-center mt-6">
            Already have an account?{' '}
            <Link href="/auth/login" className="text-blue-700 dark:text-blue-300 hover:underline font-semibold">
              Log in
            </Link>
          </motion.p>
        </Card>
      </motion.div>

      <style jsx>{`
        .animate-gradient { background-size: 300% 300%; animation: gradientShift 18s ease infinite; }
        @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
      `}</style>
    </div>
  );
}



================================================
File: app/auth/success/page.js
================================================
// File: src/app/auth/success/page.js
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Button } from '../../components/Button';
import { Card } from '../../components/Card';
import { apiFetch } from '@/lib/api';

export default function Success() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [isVerified, setIsVerified] = useState(false);

  useEffect(() => {
    const check = async () => {
      try {
        const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
        if (!token) {
          // not logged in â†’ bounce to login
          router.push('/auth/login');
          return;
        }

        // GET /api/v1/users/verification-status (auth required)
        const status = await apiFetch('/users/verification-status');
        // Adjust property name if your backend returns a different shape
        setIsVerified(Boolean(status?.verified ?? status?.is_verified ?? false));
      } catch {
        // if the call fails, treat as not verified
        setIsVerified(false);
      } finally {
        setLoading(false);
      }
    };
    check();
  }, [router]);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
        <Card className="max-w-md w-full text-center">
          <p>Checking verificationâ€¦</p>
        </Card>
      </div>
    );
  }

  if (!isVerified) {
    return (
      <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
        <Card className="max-w-md w-full text-center">
          <h2 className="text-2xl font-bold mb-4 text-yellow-600 dark:text-yellow-400">Verification Pending</h2>
          <p className="text-gray-600 dark:text-gray-400 mb-6">
            We couldnâ€™t confirm your verification yet. Please try uploading your student ID again.
          </p>
          <Link href="/auth/verify/id-upload" className="block">
            <Button variant="primary" className="w-full">Upload ID</Button>
          </Link>
        </Card>
      </div>
    );
  }

  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full text-center">
        <h2 className="text-2xl font-bold mb-4 text-green-600 dark:text-green-400">
          Verification Successful!
        </h2>
        <p className="text-gray-600 dark:text-gray-400 mb-6">
          Your account has been verified. You are now ready to explore the University Marketplace!
        </p>
        <Link href="/browse" className="block">
          <Button variant="primary" className="w-full">Start Browsing</Button>
        </Link>
      </Card>
    </div>
  );
}



================================================
File: app/auth/verify/id-upload/page.js
================================================
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { Button } from '../../../components/Button';
import { Input } from '../../../components/Input';
import { Card } from '../../../components/Card';
import { Spinner } from '../../../components/Spinner';
import { apiFetch } from '@/lib/api';

export default function IDUpload() {
  const { register, handleSubmit, formState: { errors } } = useForm();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const fileToBase64 = (file) =>
    new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

  const onSubmit = async (form) => {
    setIsLoading(true);
    setError(null);

    try {
      const file = form.idImage?.[0];
      if (!file) throw new Error('Please choose an image of your student ID.');

      // Try multipart first (no explicit content-type for FormData)
      const fd = new FormData();
      fd.append('id_image', file); // single field

      try {
        await apiFetch('/verification/upload-id', { method: 'POST', body: fd });
      } catch (e) {
        // fallback only if it's an unsupported-media/validation error
        if (!/415|422/.test(String(e?.message))) throw e;
        const b64 = await fileToBase64(file);
        await apiFetch('/verification/upload-id', {
          method: 'POST',
          body: JSON.stringify({ image_base64: b64 }),
        });
      }

      if (!ok) {
        const b64 = await fileToBase64(file);
        await apiFetch('/verification/upload-id', {
          method: 'POST',
          body: JSON.stringify({ image_base64: b64 }),
        });
      }

      window.location.href = '/auth/success';
    } catch (err) {
      setError(err.message || 'ID upload failed');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full p-6">
        <h2 className="text-2xl font-bold mb-2 text-center">Verify Your Student ID</h2>
        <p className="text-gray-600 dark:text-gray-400 mb-4 text-center">
          Upload a clear image of your student ID to verify your university affiliation.
        </p>

        {error && <p className="text-red-500 text-sm mb-4 text-center">{error}</p>}

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <Input
            label="Student ID Image"
            type="file"
            accept="image/*"
            {...register('idImage', { required: 'Student ID image is required' })}
            error={errors.idImage?.message}
          />
          <Button variant="primary" type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? <Spinner className="w-5 h-5 mx-auto" /> : 'Upload ID'}
          </Button>
        </form>
      </Card>
    </div>
  );
}



================================================
File: app/auth/verify/otp/page.js
================================================
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { useRouter } from 'next/navigation';
import { Button } from '../../../components/Button';
import { Input } from '../../../components/Input';
import { Card } from '../../../components/Card';
import { Spinner } from '../../../components/Spinner';
import { apiFetch } from '@/lib/api';

export default function OTPVerification() {
  const router = useRouter();
  const { register, handleSubmit, formState: { errors } } = useForm();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const onSubmit = async (data) => {
    setIsLoading(true);
    setError(null);
    try {
      // POST /api/v1/verification/verify-otp  (auth required)
      await apiFetch('/verification/verify-otp', {
      method: 'POST',
      body: JSON.stringify({ otp_code: data.otp }),
    });
      router.push('/auth/verify/id-upload');
    } catch (e) {
      setError(e?.message || 'Invalid OTP');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-[calc(100vh-200px)]">
      <Card className="max-w-md w-full">
        <h2 className="text-2xl font-bold mb-4 text-center">Verify Your Email</h2>
        <p className="text-gray-600 dark:text-gray-400 mb-6 text-center">
          Enter the 6-digit OTP sent to your email.
        </p>
        {error && <p className="text-red-500 text-sm mb-4 text-center">{error}</p>}
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <Input
            label="OTP"
            inputMode="numeric"
            {...register('otp', {
              required: 'OTP is required',
              pattern: { value: /^\d{6}$/, message: 'OTP must be 6 digits' },
            })}
            error={errors.otp?.message}
          />
          <Button variant="primary" type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? <Spinner className="w-5 h-5 mx-auto" /> : 'Verify OTP'}
          </Button>
        </form>
      </Card>
    </div>
  );
}



================================================
File: app/browse/page.js
================================================
// File: src/app/browse/page.js
'use client';

import { useState, useEffect } from 'react';
import SearchBar from '../components/SearchBar';
import CategoryTabs from '../components/CategoryTabs';
import ListingGrid from '../components/ListingGrid';
import Pagination from '../components/Pagination';
import { apiFetch } from '@/lib/api';

const toViewModel = (item) => ({
  ...item,
  // ListingCard expects `image`; API returns `images`
  image:
    (Array.isArray(item.images) && item.images[0]) ||
    item.image ||
    'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCBmaWxsPSIjMTgxODIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIi8+PHRleHQgeD0iNTAiIHk9IjE1MCIgZmlsbD0iI2JiYiIgc3R5bGU9ImZvbnQ6IDE2cHggL2ludGVyOyI+Tm8gaW1hZ2U8L3RleHQ+PC9zdmc+',
});

export default function Browse() {
  const [listings, setListings] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [category, setCategory] = useState('');
  const [query, setQuery] = useState('');
  const [error, setError] = useState(null);

  const pageSize = 6;

  const fetchListings = async () => {
    setIsLoading(true);
    setError(null);

    try {
      const params = new URLSearchParams({
        page: String(currentPage),
        size: String(pageSize),
        sort_by: 'created_at',
        sort_order: 'desc',
      });
      if (query) params.set('q', query);
      if (category) params.set('category', category);

      // âœ… correct endpoint
      let data = await apiFetch(`/listings/search?${params.toString()}`);

      // normalize possible shapes
      let items = data.items || data.results || data.listings || [];
      const total = data.total ?? data.count ?? items.length;

      setListings(items.map(toViewModel));
      setTotalPages(Math.max(1, Math.ceil(total / pageSize)));
    } catch (e) {
      // graceful fallback: try plain index if search isnâ€™t available
      try {
        const data = await apiFetch('/listings');
        const items = Array.isArray(data) ? data : data.items || data.listings || [];
        setListings(items.map(toViewModel));
        setTotalPages(1);
      } catch (inner) {
        const msg =
          typeof inner === 'string'
            ? inner
            : inner?.message || inner?.detail || 'Failed to fetch listings';
        setError(msg);
      }
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchListings();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentPage, category, query]);

  const handleSearch = (searchQuery) => {
    setQuery(searchQuery);
    setCurrentPage(1);
  };

  const handleCategoryChange = (newCategory) => {
    setCategory(newCategory);
    setCurrentPage(1);
  };

  const handlePageChange = (newPage) => {
    if (newPage >= 1 && newPage <= totalPages) setCurrentPage(newPage);
  };

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">Browse Listings</h1>

      <SearchBar onSearch={handleSearch} />
      <CategoryTabs activeCategory={category} onCategoryChange={handleCategoryChange} />

      {error && <p className="text-red-500">{String(error)}</p>}

      <ListingGrid listings={listings} isLoading={isLoading} />

      <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={handlePageChange} />
    </div>
  );
}



================================================
File: app/chat/page.js
================================================
// src/app/chat/page.js
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import ChatList from '../components/ChatList';
import ChatConversation from '../components/ChatConversation';
import { ensureRoomWithSeller } from '@/lib/chat';

export default function ChatPage() {
  const router = useRouter();
  const search = useSearchParams();

  const [selectedChatId, setSelectedChatId] = useState(null);
  const [starting, setStarting] = useState(false);
  const [startErr, setStartErr] = useState('');

  function cleanQuery() {
    const url = new URL(window.location.href);
    ['room', 'start', 'listing', 'toId', 'listingId'].forEach((k) =>
      url.searchParams.delete(k)
    );
    window.history.replaceState(null, '', url.toString());
  }

  useEffect(() => {
    // ?room=<id> â†’ open directly
    const room = search.get('room');
    if (room) {
      setSelectedChatId(room);
      cleanQuery();
      return;
    }

    // ?start=<sellerUserId>&listing=<listingId> (legacy: ?toId= &listingId=)
    let seller = search.get('start') || search.get('toId');
    let listing = search.get('listing') || search.get('listingId');

    if (!seller) return;

    const token =
      typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (!token) {
      router.push('/auth/login');
      return;
    }

    let cancelled = false;
    (async () => {
      setStarting(true);
      setStartErr('');
      try {
        const roomObj = await ensureRoomWithSeller({
          sellerUserId: seller,
          listingId: listing || undefined,
        });
        const id = roomObj?.id || roomObj?.room_id;
        if (!cancelled) {
          if (!id) {
            setStartErr('Not Found');
          } else {
            setSelectedChatId(String(id));
          }
          cleanQuery();
        }
      } catch (e) {
        if (!cancelled) {
          setStartErr(String(e?.message || 'Failed to start chat'));
        }
      } finally {
        if (!cancelled) setStarting(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [router, search]);

  return (
    <div className="container mx-auto p-4 flex gap-4">
      <div className="w-full md:w-1/3">
        <h1 className="text-2xl font-bold mb-4">Chats</h1>

        {startErr && (
          <div className="text-red-500 mb-3 whitespace-pre-line">{startErr}</div>
        )}
        {starting && (
          <div className="text-sm text-gray-400 mb-3">Starting chatâ€¦</div>
        )}

        <ChatList onSelectChat={setSelectedChatId} />
      </div>

      <div className="hidden md:block w-2/3">
        {starting ? (
          <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
            <p className="text-gray-400">Starting chatâ€¦</p>
          </div>
        ) : selectedChatId ? (
          <ChatConversation chatId={selectedChatId} />
        ) : (
          <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
            <p className="text-gray-500">Select a chat to start messaging</p>
          </div>
        )}
      </div>
    </div>
  );
}



================================================
File: app/components/Button.js
================================================
import Link from 'next/link';
import { cn } from '../../../lib/utils';

export function Button({
  variant = 'primary',
  disabled,
  children,
  className,
  href,
  ...props
}) {
  const baseStyles =
    'inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-150';
  const variants = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500',
    destructive: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
  };
  const disabledStyles = 'opacity-50 cursor-not-allowed pointer-events-none';

  const classes = cn(
    baseStyles,
    variants[variant] || variants.primary,
    disabled && disabledStyles,
    className
  );

  // If href is provided, render a Next.js Link directly
  if (href) {
    return (
      <Link href={href} className={classes} {...props}>
        {children}
      </Link>
    );
  }

  // Otherwise, render a regular button
  return (
    <button className={classes} disabled={disabled} {...props}>
      {children}
    </button>
  );
}


================================================
File: app/components/Card.js
================================================
export function Card({ children, className }) {
  return (
    <div className={`bg-white dark:bg-gray-800 shadow rounded-lg p-6 ${className}`}>
      {children}
    </div>
  );
}


================================================
File: app/components/CategoryTabs.js
================================================
// src/app/components/CategoryTabs.js
export default function CategoryTabs({ activeCategory, onCategoryChange }) {
  const categories = ['All', 'Textbooks', 'Electronics', 'Furniture'];

  return (
    <div className="flex space-x-4 border-b border-gray-200 dark:border-gray-700">
      {categories.map((category) => (
        <button
          key={category}
          onClick={() => onCategoryChange(category === 'All' ? '' : category)}
          className={`py-2 px-4 text-sm font-medium ${
            activeCategory === (category === 'All' ? '' : category)
              ? 'border-b-2 border-blue-500 text-blue-500'
              : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'
          }`}
        >
          {category}
        </button>
      ))}
    </div>
  );
}


================================================
File: app/components/ChatConversation.js
================================================
"use client";

import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import { apiFetch } from "@/lib/api";

/**
 * Chat room UI:
 * - GET  /api/v1/chat/rooms/{room_id}/messages
 * - POST /api/v1/chat/rooms/{room_id}/messages   (text message)
 *   If your backend expects a specific key, keep "text" and itâ€™ll work; we also
 *   send {body, content} as the same value to be extra compatible.
 */
export default function ChatConversation({ chatId }) {
  const [messages, setMessages] = useState([]);
  const [text, setText] = useState("");
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [err, setErr] = useState("");

  const bottomRef = useRef(null);

  const roomPath = useMemo(
    () => `/chat/rooms/${encodeURIComponent(chatId)}`,
    [chatId]
  );

  const scrollToBottom = useCallback(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
  }, []);

  const loadMessages = useCallback(async () => {
    setErr("");
    try {
      const data = await apiFetch(`${roomPath}/messages`, { cache: "no-store" });
      // Accept both direct arrays or {messages: [...]}
      const list = Array.isArray(data) ? data : data?.messages || [];
      setMessages(list);
    } catch (e) {
      setErr(String(e?.message || "Failed to load messages"));
    } finally {
      setLoading(false);
      // allow DOM to paint before scrolling
      setTimeout(scrollToBottom, 50);
    }
  }, [roomPath, scrollToBottom]);

  useEffect(() => {
    let stop = false;

    (async () => {
      setLoading(true);
      await loadMessages();
      // simple polling for new messages (every 5s)
      const id = setInterval(() => !stop && loadMessages(), 5000);
      return () => clearInterval(id);
    })();

    return () => {
      stop = true;
    };
  }, [loadMessages]);

  async function handleSend(e) {
    e?.preventDefault?.();
    if (!text.trim() || sending) return;

    const payload = {
      text,            // most backends accept "text"
      body: text,      // fallback key
      content: text,   // another fallback key
    };

    setSending(true);
    setErr("");

    // optimistic append
    const temp = {
      id: `tmp-${Date.now()}`,
      text,
      mine: true,
      created_at: new Date().toISOString(),
    };
    setMessages((prev) => [...prev, temp]);
    setText("");
    scrollToBottom();

    try {
      const saved = await apiFetch(`${roomPath}/messages`, {
        method: "POST",
        body: JSON.stringify(payload),
      });

      // Replace the temp message with server version if it returns one
      setMessages((prev) => {
        const copy = [...prev];
        const idx = copy.findIndex((m) => m.id === temp.id);
        if (idx !== -1) copy[idx] = saved || copy[idx];
        return copy;
      });
    } catch (e) {
      setErr(String(e?.message || "Failed to send"));
      // rollback optimistic append
      setMessages((prev) => prev.filter((m) => m.id !== temp.id));
      setText(temp.text);
    } finally {
      setSending(false);
      scrollToBottom();
    }
  }

  // ------- UI -------
  if (loading) return <div className="p-4">Loading conversationâ€¦</div>;

  return (
    <div className="flex flex-col h-[calc(100vh-6rem)] border border-gray-800 rounded">
      {/* Error line (non-blocking) */}
      {err ? (
        <div className="px-4 py-2 text-sm text-red-500 border-b border-gray-800">
          {err}
        </div>
      ) : null}

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-3">
        {messages.map((m) => {
          const mine = m.mine || m.is_mine || m.sender?.is_me || m.sender === "You";
          const body = m.text ?? m.body ?? m.content ?? m.message ?? "";
          const ts = m.created_at ?? m.timestamp;

          return (
            <div
              key={m.id || `${ts}-${Math.random()}`}
              className={`max-w-[70%] px-3 py-2 rounded whitespace-pre-wrap break-words ${
                mine
                  ? "ml-auto bg-blue-600 text-white"
                  : "mr-auto bg-gray-800 text-gray-100"
              }`}
            >
              <div>{body}</div>
              {ts ? (
                <div className="mt-1 text-[10px] opacity-70">
                  {new Date(ts).toLocaleString()}
                </div>
              ) : null}
            </div>
          );
        })}
        <div ref={bottomRef} />
      </div>

      {/* Composer */}
      <form onSubmit={handleSend} className="p-3 border-t border-gray-800 flex gap-2">
        <input
          className="flex-1 rounded bg-gray-900 border border-gray-700 px-3 py-2 outline-none"
          placeholder="Type a messageâ€¦"
          value={text}
          onChange={(e) => setText(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === "Enter" && !e.shiftKey) handleSend(e);
          }}
        />
        <button
          type="submit"
          disabled={sending || !text.trim()}
          className="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 disabled:opacity-60"
        >
          {sending ? "Sendingâ€¦" : "Send"}
        </button>
      </form>
    </div>
  );
}



================================================
File: app/components/ChatList.js
================================================
"use client";

import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import Link from "next/link";
import { apiFetch } from "@/lib/api";

/**
 * Lists the user's chat rooms and notifies parent via onSelectChat(roomId)
 */
export default function ChatList({ onSelectChat }) {
  const [rooms, setRooms] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState("");
  const [needLogin, setNeedLogin] = useState(false);

  // track the current poll to cancel it on unmount / rerun
  const pollRef = useRef({ abort: () => {} });

  const hasToken = useMemo(
    () => (typeof window !== "undefined" ? !!localStorage.getItem("token") : false),
    []
  );

  const stopPolling = useCallback(() => {
    try {
      pollRef.current.abort?.();
    } catch {}
  }, []);

  const loadRooms = useCallback(async () => {
    setErr("");
    if (!hasToken) {
      setNeedLogin(true);
      setLoading(false);
      return;
    }

    // abortable request (prevents “signal is aborted without reason” on route changes)
    const controller = new AbortController();
    pollRef.current = controller;

    try {
      const data = await apiFetch("/chat/rooms", {
        cache: "no-store",
        signal: controller.signal,
      });
      setRooms(Array.isArray(data) ? data : []);
    } catch (e) {
      const msg = String(e?.message || "Failed to load chat rooms");
      // if auth error, hint login
      if (msg.includes("401") || /unauth/i.test(msg)) setNeedLogin(true);
      setErr(msg);
    } finally {
      if (!controller.signal.aborted) setLoading(false);
    }
  }, [hasToken]);

  useEffect(() => {
    let stopped = false;

    (async () => {
      await loadRooms();
      // 30s polling
      const id = setInterval(() => {
        if (!stopped) loadRooms();
      }, 30000);
      pollRef.current.cleanup = () => clearInterval(id);
    })();

    return () => {
      stopped = true;
      stopPolling();
      pollRef.current.cleanup?.();
    };
  }, [loadRooms, stopPolling]);

  const refresh = () => {
    setLoading(true);
    loadRooms();
  };

  if (loading) return <div className="p-4">Loading chats…</div>;

  if (needLogin)
    return (
      <div className="p-4 text-gray-400">
        Please{" "}
        <Link className="underline" href="/auth/login">
          log in
        </Link>{" "}
        to view your chats.
      </div>
    );

  if (err)
    return (
      <div className="p-4">
        <div className="text-red-500 mb-2">Error: {err}</div>
        <button
          onClick={refresh}
          className="px-3 py-1 rounded bg-gray-800 hover:bg-gray-700"
        >
          Retry
        </button>
      </div>
    );

  if (!rooms.length) return <div className="p-4">No chats yet.</div>;

  return (
    <ul className="divide-y divide-gray-800 rounded border border-gray-800">
      {rooms.map((r) => {
        const id = r.id ?? r.room_id ?? r._id;
        const peer =
          r?.peer_user?.name ??
          r?.peer_user?.email ??
          r?.peer?.name ??
          r?.peer?.email ??
          r?.title ??
          r?.room_name ??
          "Chat";
        const lastMsg =
          r?.last_message?.text ??
          r?.last_message?.body ??
          (typeof r?.last_message === "string" ? r.last_message : "") ??
          "";

        return (
          <li
            key={id}
            className="p-4 cursor-pointer hover:bg-gray-800/40"
            onClick={() => id && onSelectChat?.(id)}
          >
            <div className="font-semibold">{peer}</div>
            {lastMsg && (
              <div className="text-sm text-gray-400 line-clamp-1">{lastMsg}</div>
            )}
          </li>
        );
      })}
    </ul>
  );
}



================================================
File: app/components/Checkbox.js
================================================
// File: src/app/components/Checkbox.js
import { forwardRef } from 'react';

const Checkbox = forwardRef(({ label, ...props }, ref) => {
  return (
    <div className="flex items-center space-x-2">
      <input
        type="checkbox"
        ref={ref}
        className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"
        {...props}
      />
      {label && (
        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">
          {label}
        </label>
      )}
    </div>
  );
});

Checkbox.displayName = 'Checkbox';
export default Checkbox;


================================================
File: app/components/EmptyState.js
================================================
// File: uni-market/src/app/components/EmptyState.js
import { cn } from '../../../lib/utils';

export function EmptyState({ title, description, action, className, ...props }) {
  return (
    <div
      className={cn(
        'flex flex-col items-center justify-center p-6 bg-gray-100 dark:bg-gray-800 rounded-md',
        className
      )}
      {...props}
    >
      <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">{title}</h3>
      <p className="mt-2 text-sm text-gray-500 dark:text-gray-400">{description}</p>
      {action && <div className="mt-4">{action}</div>}
    </div>
  );
}


================================================
File: app/components/ImageCarousel.js
================================================
// src/app/components/ImageCarousel.js
"use client";

import { useEffect, useMemo, useState } from "react";
import Image from "next/image";
import { toImageUrl } from "@/lib/api";

export default function ImageCarousel({ images = [] }) {
  // Normalize incoming paths -> absolute URLs
  const normalized = useMemo(
    () => (Array.isArray(images) ? images : [])
      .filter(Boolean)
      .map(toImageUrl),
    [images]
  );

  const [index, setIndex] = useState(0);
  const [hadError, setHadError] = useState(false);

  // Keep index in range when images prop changes
  useEffect(() => {
    if (index >= normalized.length) setIndex(0);
  }, [normalized.length, index]);

  // Reset error state when slide changes
  useEffect(() => {
    setHadError(false);
  }, [index]);

  const hasImages = normalized.length > 0;

  const next = () =>
    setIndex((v) => (normalized.length ? (v + 1) % normalized.length : 0));
  const prev = () =>
    setIndex((v) =>
      normalized.length ? (v - 1 + normalized.length) % normalized.length : 0
    );

  if (!hasImages) {
    return (
      <div className="w-full h-64 bg-gray-200 flex items-center justify-center rounded-lg">
        No Images Available
      </div>
    );
  }

  const displaySrc = hadError ? "/placeholder.png" : normalized[index];

  return (
    <div className="relative w-full max-w-2xl mx-auto">
      <Image
        src={displaySrc}
        alt="Product Image"
        width={900}
        height={600}
        className="w-full h-64 object-cover rounded-lg"
        onError={() => setHadError(true)}
        // Skip optimizer to avoid local dev issues with external hosts
        unoptimized
        priority={index === 0}
      />

      {normalized.length > 1 && (
        <>
          <button
            onClick={prev}
            className="absolute left-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white p-2 rounded-full"
            aria-label="Previous image"
          >
            &lt;
          </button>
          <button
            onClick={next}
            className="absolute right-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white p-2 rounded-full"
            aria-label="Next image"
          >
            &gt;
          </button>
        </>
      )}
    </div>
  );
}



================================================
File: app/components/ImageUpload.js
================================================
// File: src/app/components/ImageUpload.js
import { forwardRef } from 'react';

const ImageUpload = forwardRef(({ onChange, multiple, accept }, ref) => {
  return (
    <div className="flex items-center justify-center w-full">
      <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
        <div className="flex flex-col items-center justify-center pt-5 pb-6">
          <svg
            className="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 20 16"
          >
            <path
              stroke="currentColor"
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
            />
          </svg>
          <p className="mb-2 text-sm text-gray-500 dark:text-gray-400">
            <span className="font-semibold">Click to upload</span> or drag and drop
          </p>
          <p className="text-xs text-gray-500 dark:text-gray-400">
            PNG, JPG, or GIF (Max 5MB)
          </p>
        </div>
        <input
          ref={ref}
          type="file"
          className="hidden"
          onChange={onChange}
          multiple={multiple}
          accept={accept}
        />
      </label>
    </div>
  );
});

ImageUpload.displayName = 'ImageUpload';
export default ImageUpload;


================================================
File: app/components/Input.js
================================================
// File: uni-market/src/app/components/Input.js
import { cn } from '../../../lib/utils';

export function Input({ label, error, id, name, className, ...props }) {
  const inputId = id || name;

  return (
    <div className="flex flex-col space-y-1">
      {label && (
        <label
          htmlFor={inputId}
          className="text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {label}
        </label>
      )}
      <input
        id={inputId}
        name={name}
        className={cn(
          'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-50 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:placeholder:text-gray-500',
          className
        )}
        {...props}
      />
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
}


================================================
File: app/components/ListingCard.js
================================================
import Link from "next/link";
import Image from "next/image";
import { Heart, MessageCircle, ShoppingCart } from "lucide-react";
import { toImageUrl, apiFetch } from "@/lib/api";
import { useMemo, useState } from "react";
import { formatPKR } from "../../utils/format"; // if you donâ€™t have this, just use Intl below

export default function ListingCard({ listing, showFavoriteToggle = false }) {
  const [isFavorite, setIsFavorite] = useState(!!listing?.is_favorite);

  const firstPath = useMemo(
    () =>
      Array.isArray(listing?.images) && listing.images.length
        ? listing.images[0]
        : listing?.image || "",
    [listing]
  );

  const [imgSrc, setImgSrc] = useState(
    firstPath ? toImageUrl(firstPath) : "/placeholder.png"
  );

  const toggleFavorite = async () => {
    try {
      await apiFetch(`/favorites/${listing.id}`, { method: "POST" });
      setIsFavorite((prev) => !prev);
    } catch (err) {
      console.error("Error toggling favorite:", err);
    }
  };

  const price =
    typeof Intl !== "undefined"
      ? new Intl.NumberFormat("en-PK", { style: "currency", currency: "PKR", maximumFractionDigits: 0 }).format(Number(listing?.price ?? 0))
      : `Rs ${Number(listing?.price ?? 0).toLocaleString("en-PK")}`;

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden relative group">
      {showFavoriteToggle && (
        <button
          onClick={toggleFavorite}
          className="absolute top-2 right-2 z-10 p-1 rounded-full bg-white/80 dark:bg-gray-700/70 hover:bg-white dark:hover:bg-gray-600 transition"
          aria-label="Toggle favorite"
        >
          <Heart
            className={`w-5 h-5 ${
              isFavorite ? "fill-red-500 text-red-500" : "text-gray-500"
            }`}
          />
        </button>
      )}

      {/* Make the whole visual area a link */}
      <Link href={`/listing/${listing.id}`} className="block focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div className="relative h-40">
          <Image
            src={imgSrc}
            alt={listing?.title ?? "Listing image"}
            fill
            sizes="(max-width:768px) 100vw, (max-width:1200px) 50vw, 33vw"
            className="object-cover transition-transform duration-200 group-hover:scale-[1.02]"
            onError={() => setImgSrc("/placeholder.png")}
            unoptimized
          />
        </div>

        <div className="p-4">
          <h3 className="text-lg font-semibold truncate">{listing?.title}</h3>
          <p className="text-sm text-gray-600 dark:text-gray-400">
            {listing?.category}
          </p>
          <p className="text-lg font-bold text-blue-500">{price}</p>
          <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-2">
            {listing?.description}
          </p>
        </div>
      </Link>

      {/* Action bar */}
      <div className="flex items-center gap-2 px-4 pb-4 -mt-2">
        <Link
          href={`/listing/${listing.id}`}
          className="flex-1 text-center py-2 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition"
        >
          View
        </Link>
        <Link
          href={`/chat?toId=${encodeURIComponent(
            listing?.seller_id ?? listing?.owner_id ?? ""
          )}&listingId=${listing.id}`}
          className="p-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white"
          title="Chat with seller"
        >
          <MessageCircle className="w-5 h-5" />
        </Link>
        <Link
          href={`/listing/${listing.id}#buy`}
          className="p-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white"
          title="Buy / Make offer"
        >
          <ShoppingCart className="w-5 h-5" />
        </Link>
      </div>
    </div>
  );
}



================================================
File: app/components/ListingGrid.js
================================================
// src/app/components/ListingGrid.js
import ListingCard from './ListingCard';
import SkeletonCard from './SkeletonCard';

export default function ListingGrid({ listings, isLoading }) {
  if (isLoading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {Array(6)
          .fill()
          .map((_, i) => (
            <SkeletonCard key={i} />
          ))}
      </div>
    );
  }

  if (listings.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-lg text-gray-600 dark:text-gray-400">No listings found.</p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {listings.map((listing) => (
        <ListingCard key={listing.id} listing={listing} />
      ))}
    </div>
  );
}


================================================
File: app/components/Pagination.js
================================================
// src/app/components/Pagination.js
export default function Pagination({ currentPage, totalPages, onPageChange }) {
  return (
    <div className="flex justify-center space-x-2 mt-8">
      <button
        onClick={() => onPageChange(currentPage - 1)}
        disabled={currentPage === 1}
        className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50"
      >
        Previous
      </button>
      <span className="px-4 py-2 text-gray-600 dark:text-gray-400">
        Page {currentPage} of {totalPages}
      </span>
      <button
        onClick={() => onPageChange(currentPage + 1)}
        disabled={currentPage === totalPages}
        className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50"
      >
        Next
      </button>
    </div>
  );
}


================================================
File: app/components/ProductDetails.js
================================================
// File: src/app/components/ProductDetails.js
import { Card, CardContent, CardTitle } from '@/components/ui/card';

function ProductDetails({ listing }) {
  return (
    <Card className="w-full max-w-2xl mx-auto mt-4">
      <CardContent className="space-y-2">
        <CardTitle>{listing.title}</CardTitle>
        <p className="text-xl font-bold">${listing.price}</p>
        <p><strong>Condition:</strong> {listing.condition || 'Not specified'}</p>
        <p><strong>Description:</strong> {listing.description || 'No description available'}</p>
      </CardContent>
    </Card>
  );
}

export default ProductDetails;


================================================
File: app/components/ReconnectBanner.js
================================================
// File: src/app/components/ReconnectBanner.js
// app/components/ReconnectBanner.js
const ReconnectBanner = () => (
  <div className="bg-yellow-100 text-yellow-800 p-2 text-center">
    Connection lost. Attempting to reconnect...
  </div>
);

export default ReconnectBanner;


================================================
File: app/components/SearchBar.js
================================================
// src/app/components/SearchBar.js
import { useState, useEffect } from 'react';
import debounce from 'lodash.debounce';

export default function SearchBar({ onSearch }) {
  const [query, setQuery] = useState('');

  const debouncedSearch = debounce((value) => {
    onSearch(value);
  }, 500);

  const handleChange = (e) => {
    const value = e.target.value;
    setQuery(value);
    debouncedSearch(value);
  };

  useEffect(() => {
    return () => {
      debouncedSearch.cancel();
    };
  }, [debouncedSearch]);

  return (
    <div className="relative">
      <input
        type="text"
        value={query}
        onChange={handleChange}
        placeholder="Search listings..."
        className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100"
      />
      <svg
        className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
    </div>
  );
}


================================================
File: app/components/Select.js
================================================
// File: src/app/components/Select.js
import { forwardRef } from 'react';

const Select = forwardRef(({ options, value, onChange, name, className = '', ...props }, ref) => {
  return (
    <select
      ref={ref}
      name={name}
      value={value}
      onChange={onChange}
      className={`w-full px-3 py-2 text-sm border rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
      {...props}
    >
      {options.map((option) => (
        <option key={option.value} value={option.value} disabled={option.value === ''}>
          {option.label}
        </option>
      ))}
    </select>
  );
});

Select.displayName = 'Select';
export default Select;


================================================
File: app/components/SellerLink.js
================================================
// File: src/app/components/SellerLink.js
import { Button } from '@/components/ui/button';
import Link from 'next/link';

function SellerLink({ sellerId, sellerName }) {
  return (
    <div className="w-full max-w-2xl mx-auto mt-4 flex space-x-4">
      <Link href={`/profile?user=${sellerId}`}>
        <Button variant="outline">View Seller Profile</Button>
      </Link>
      <Button onClick={() => alert(`Chat with ${sellerName} initiated!`)}>Chat with Seller</Button>
    </div>
  );
}

export default SellerLink;


================================================
File: app/components/Skeleton.js
================================================
// File: uni-market/src/app/components/Skeleton.js
import { cn } from '../../../lib/utils';

export function Skeleton({ className, ...props }) {
  return (
    <div
      className={cn('animate-pulse rounded-md bg-gray-200 dark:bg-gray-700', className)}
      {...props}
    />
  );
}


================================================
File: app/components/SkeletonCard.js
================================================
// src/app/components/SkeletonCard.js
export default function SkeletonCard() {
  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 animate-pulse">
      <div className="w-full h-40 bg-gray-200 dark:bg-gray-700 rounded-md"></div>
      <div className="mt-4 space-y-2">
        <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
        <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
        <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
      </div>
    </div>
  );
}


================================================
File: app/components/Spinner.js
================================================
// File: uni-market/src/app/components/Spinner.js
import { cn } from '../../../lib/utils';

export function Spinner({ className, ...props }) {
  return (
    <div
      className={cn(
        'inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent',
        className
      )}
      {...props}
    />
  );
}


================================================
File: app/components/Textarea.js
================================================
import React, { useId } from 'react';

const Textarea = ({ 
  label, 
  error, 
  helperText, 
  size = 'md',
  rows = 4,
  className = '',
  id,
  required = false,
  ...props 
}) => {
  const generatedId = useId();
  const textareaId = id || generatedId;
  
  const sizes = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-3 py-2.5 text-sm',
    lg: 'px-4 py-3 text-base'
  };

  const baseClasses = `
    block w-full rounded-lg border transition-colors duration-200 
    placeholder-gray-400 focus:outline-none focus:ring-1 resize-vertical
    ${error 
      ? 'border-red-300 focus:border-red-500 focus:ring-red-500' 
      : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'
    }
  `;

  return (
    <div className="w-full">
      {label && (
        <label 
          htmlFor={textareaId}
          className="block text-sm font-medium text-gray-700 mb-1.5"
        >
          {label}
          {required && <span className="text-red-500 ml-1">*</span>}
        </label>
      )}
      <textarea
        id={textareaId}
        rows={rows}
        className={`${baseClasses} ${sizes[size]} ${className}`}
        {...props}
      />
      {error && (
        <p className="mt-1.5 text-sm text-red-600 flex items-center">
          <svg className="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {error}
        </p>
      )}
      {helperText && !error && (
        <p className="mt-1.5 text-sm text-gray-500">{helperText}</p>
      )}
    </div>
  );
};

export default Textarea;


================================================
File: app/components/TopNav.js
================================================
// File: src/app/components/TopNav.js
'use client';

import Link from 'next/link';
import { useEffect, useState } from 'react';
import { apiFetch } from '@/lib/api';

export default function TopNav() {
  const [me, setMe] = useState(null);
  const [menuOpen, setMenuOpen] = useState(false);

  // Try to load current user if we have a token
  useEffect(() => {
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (!token) return;

    (async () => {
      try {
        const user = await apiFetch('/auth/me', { cache: 'no-store' });
        setMe(user || null);
      } catch {
        // if token invalid, clear it
        localStorage.removeItem('token');
        setMe(null);
      }
    })();
  }, []);

  function logout() {
    localStorage.removeItem('token');
    setMe(null);
    if (typeof window !== 'undefined') window.location.href = '/';
  }

  const avatarLetter = (me?.name?.[0] || me?.email?.[0] || 'U').toUpperCase();

  return (
    <header className="bg-white dark:bg-gray-800 shadow sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold">
          <Link href="/">University Marketplace</Link>
        </h1>

        <nav className="hidden md:flex items-center gap-5">
          <Link
            href="/browse"
            className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
          >
            Browse
          </Link>

          <Link
            href="/favorites"
            className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
          >
            Favorites
          </Link>
          <Link
            href="/notifications"
            className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
          >
            Notifications
          </Link>

          {me ? (
            <>
              <Link
                href="/my-listings"
                className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                My Listings
              </Link>
              <Link
                href="/create-listing"
                className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                Create Listing
              </Link>
              <Link
                href="/chat"
                className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                Chat
              </Link>
              {me && !me?.is_verified && (
                <Link
                    href="/admin"
                    className="text-sm font-medium text-yellow-400 hover:text-yellow-500"
                >
                    Admin
                </Link>
                )}

              <div className="relative">
                <button
                  onClick={() => setMenuOpen((v) => !v)}
                  className="w-9 h-9 rounded-full bg-blue-600 text-white grid place-items-center font-semibold"
                  aria-label="Profile menu"
                >
                  {avatarLetter}
                </button>

                {menuOpen && (
                  <div
                    className="absolute right-0 mt-2 w-56 rounded-md bg-white dark:bg-gray-700 shadow-lg ring-1 ring-black/5 py-1"
                    onMouseLeave={() => setMenuOpen(false)}
                  >
                    <div className="px-4 py-2 text-sm text-gray-700 dark:text-gray-200">
                      <div className="font-semibold">{me?.name || 'User'}</div>
                      <div className="text-gray-500 dark:text-gray-300 truncate">
                        {me?.email}
                      </div>
                    </div>
                    <hr className="border-gray-200 dark:border-gray-600" />
                    <Link
                      href="/profile"
                      className="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"
                      onClick={() => setMenuOpen(false)}
                    >
                      Profile
                    </Link>
                    <Link
                      href="/my-listings"
                      className="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"
                      onClick={() => setMenuOpen(false)}
                    >
                      My Listings
                    </Link>
                    <Link
                      href="/chat"
                      className="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"
                      onClick={() => setMenuOpen(false)}
                    >
                      Messages
                    </Link>
                    <button
                      className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"
                      onClick={logout}
                    >
                      Logout
                    </button>
                  </div>
                )}
              </div>
            </>
          ) : (
            <>
              <Link
                href="/auth/login"
                className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                Login
              </Link>
              <Link
                href="/auth/sign-up"
                className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                Sign Up
              </Link>
            </>
          )}
        </nav>

        {/* Mobile minimal items */}
        <div className="md:hidden">
          <Link
            href="/browse"
            className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
          >
            Browse
          </Link>
          {me ? (
            <Link
              href="/chat"
              className="ml-4 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
            >
              Chat
            </Link>
          ) : (
            <Link
              href="/auth/login"
              className="ml-4 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
            >
              Login
            </Link>
          )}
        </div>
      </div>
    </header>
  );
}



================================================
File: app/components/Typography.js
================================================
// File: components/Typography.js
export function H1({ children }) {
  return <h1 className="text-3xl font-semibold">{children}</h1>
}
export function H2({ children }) {
  return <h2 className="text-2xl font-semibold">{children}</h2>
}
export function P({ children }) {
  return <p className="text-sm text-slate-700">{children}</p>
}


================================================
File: app/create-listing/page.js
================================================
// File: src/app/create-listing/page.js
'use client';

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import { Button } from '../components/Button';
import { Input } from '../components/Input';
import Textarea from '../components/Textarea';
import Select from '../components/Select';
import Checkbox from '../components/Checkbox';
import ImageUpload from '../components/ImageUpload';
import { apiFetch } from '@/lib/api';

function formatPKR(n) {
  const x = Number(n);
  if (!Number.isFinite(x)) return '';
  return `â‚¨ ${x.toLocaleString('en-PK')}`;
}

export default function CreateListing() {
  const router = useRouter();

  const [formData, setFormData] = useState({
    title: '',
    description: '',
    price: '',
    category: '',
    condition: '',
    negotiable: false,
  });

  const [images, setImages] = useState([]);
  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitError, setSubmitError] = useState('');

  // AI state
  const [aiLoading, setAiLoading] = useState(false);
  const [aiMsg, setAiMsg] = useState('');
  const [aiErr, setAiErr] = useState('');

  const fileInputRef = useRef(null);

  // ---------- helpers ----------
  const validateForm = () => {
    const e = {};
    if (!formData.title.trim()) e.title = 'Title is required';
    if (!formData.description.trim()) e.description = 'Description is required';
    if (!formData.category) e.category = 'Category is required';
    if (!formData.condition) e.condition = 'Condition is required';
    if (!formData.price || Number(formData.price) <= 0) e.price = 'Price must be a positive number';
    if (images.length === 0) e.images = 'At least one image is required';
    setErrors(e);
    return Object.keys(e).length === 0;
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData((prev) => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    setErrors((prev) => ({ ...prev, [name]: null }));
  };

  const handleImageUpload = (e) => {
    const files = Array.from(e.target.files || []);
    const newImages = files.map((file) => ({ file, preview: URL.createObjectURL(file) }));
    setImages((prev) => [...prev, ...newImages]);
    setErrors((prev) => ({ ...prev, images: null }));
  };

  const removeImage = (index) => setImages((prev) => prev.filter((_, i) => i !== index));

  // ---------- AI price (PKR) ----------
  const fetchAiSuggestion = async () => {
    setAiErr('');
    setAiMsg('');

    // require the 4 fields the model needs
    if (!formData.title || !formData.description || !formData.category || !formData.condition) {
      setAiErr('Please fill Title, Description, Category and Condition first.');
      return;
    }

    setAiLoading(true);
    try {
      const payload = {
        title: formData.title,
        description: formData.description,
        category: formData.category,
        condition: formData.condition,
      };

      const data = await apiFetch('/ai/price-suggest', {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      // accept common property names
      const suggested = Number(
        data?.price ?? data?.suggested_price ?? data?.prediction ?? data?.predicted_price
      );

      if (!Number.isFinite(suggested)) {
        throw new Error('Model did not return a numeric price.');
      }

      setFormData((prev) => ({ ...prev, price: suggested }));
      setAiMsg(`Suggested price: ${formatPKR(suggested)}`);
      setTimeout(() => setAiMsg(''), 6000);
    } catch (err) {
      setAiErr(err?.message || 'Failed to fetch price suggestion.');
      setTimeout(() => setAiErr(''), 6000);
    } finally {
      setAiLoading(false);
    }
  };

  // ---------- submit ----------
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!validateForm()) return;

    // require auth
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (!token) {
      setSubmitError('Please log in to create a listing.');
      router.push('/auth/login');
      return;
    }

    setIsSubmitting(true);
    setSubmitError('');
    try {
      const fd = new FormData();
      fd.append('title', formData.title);
      fd.append('description', formData.description);
      fd.append('price', String(formData.price)); // PKR
      fd.append('category', formData.category);
      fd.append('condition', formData.condition);
      fd.append('negotiable', String(formData.negotiable));
      images.forEach((img) => fd.append('images', img.file));

      const res = await fetch('/api/v1/listings', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }, // don't set Content-Type for FormData
        body: fd,
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData?.message || `Failed to create listing (${res.status})`);
      }

      const created = await res.json();
      router.push(`/listing/${created.id}`);
    } catch (err) {
      setSubmitError(err.message || 'Failed to create listing');
    } finally {
      setIsSubmitting(false);
    }
  };

  // ---------- UI ----------
  return (
    <div className="relative min-h-screen flex items-center justify-center px-4 py-10 overflow-hidden">
      {/* bg */}
      <div className="absolute inset-0 animate-gradient bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900" />
      <motion.div
        className="pointer-events-none absolute -top-24 -left-24 w-[28rem] h-[28rem] rounded-full bg-white/20 blur-3xl"
        animate={{ y: [0, 30, 0], x: [0, 20, 0] }}
        transition={{ duration: 15, repeat: Infinity, ease: 'easeInOut' }}
      />
      <motion.div
        className="pointer-events-none absolute -bottom-28 -right-28 w-[32rem] h-[32rem] rounded-full bg-blue-400/25 blur-3xl"
        animate={{ y: [0, -25, 0], x: [0, -30, 0] }}
        transition={{ duration: 18, repeat: Infinity, ease: 'easeInOut' }}
      />

      <motion.div
        initial={{ opacity: 0, y: 40 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
        className="relative z-10 w-full max-w-3xl"
      >
        <div className="p-8 rounded-2xl shadow-xl bg-white/80 backdrop-blur-xl border border-white/30 dark:bg-white/10">
          <h1 className="text-4xl font-extrabold text-center text-blue-900 dark:text-white mb-8 tracking-tight">
            Create a New Listing
          </h1>

          {!!submitError && <p className="text-red-500 text-center">{submitError}</p>}
          {!!aiErr && <div className="p-3 mt-3 rounded bg-red-100 text-red-700 text-sm">{aiErr}</div>}
          {!!aiMsg && <div className="p-3 mt-3 rounded bg-green-100 text-green-700 text-sm">{aiMsg}</div>}

          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Title */}
            <div>
              <label className="block text-sm font-semibold text-blue-900 dark:text-white">Title</label>
              <Input
                name="title"
                value={formData.title}
                onChange={handleInputChange}
                placeholder="e.g., Calculus Textbook"
                className={errors.title ? 'border-red-500' : ''}
              />
              {errors.title && <p className="text-red-500 text-sm">{errors.title}</p>}
            </div>

            {/* Description */}
            <div>
              <label className="block text-sm font-semibold text-blue-900 dark:text-white">Description</label>
              <Textarea
                name="description"
                value={formData.description}
                onChange={handleInputChange}
                placeholder="Describe your item..."
                className={errors.description ? 'border-red-500' : ''}
              />
              {errors.description && <p className="text-red-500 text-sm">{errors.description}</p>}
            </div>

            {/* Category */}
            <div>
              <label className="block text-sm font-semibold text-blue-900 dark:text-white">Category</label>
              <Select
                name="category"
                value={formData.category}
                onChange={handleInputChange}
                options={[
                  { value: '', label: 'Select a category' },
                  { value: 'textbooks', label: 'Textbooks' },
                  { value: 'electronics', label: 'Electronics' },
                  { value: 'furniture', label: 'Furniture' },
                  { value: 'other', label: 'Other' },
                ]}
                className={errors.category ? 'border-red-500' : ''}
              />
              {errors.category && <p className="text-red-500 text-sm">{errors.category}</p>}
            </div>

            {/* Condition */}
            <div>
              <label className="block text-sm font-semibold text-blue-900 dark:text-white">Condition</label>
              <Select
                name="condition"
                value={formData.condition}
                onChange={handleInputChange}
                options={[
                  { value: '', label: 'Select condition' },
                  { value: 'new', label: 'New' },
                  { value: 'like-new', label: 'Like New' },
                  { value: 'used', label: 'Used' },
                  { value: 'poor', label: 'Poor' },
                ]}
                className={errors.condition ? 'border-red-500' : ''}
              />
              {errors.condition && <p className="text-red-500 text-sm">{errors.condition}</p>}
            </div>

            {/* Price (at end) + AI */}
            <div className="flex flex-col md:flex-row md:items-end gap-4">
              <div className="flex-1">
                <label className="block text-sm font-semibold text-blue-900 dark:text-white">Price (â‚¨)</label>
                <div className="flex gap-2">
                  <Input
                    name="price"
                    type="number"
                    min="0"
                    step="1"
                    value={formData.price}
                    onChange={handleInputChange}
                    placeholder="e.g., 2999"
                    className={errors.price ? 'border-red-500' : ''}
                  />
                  <Button
                    type="button"
                    variant="secondary"
                    onClick={fetchAiSuggestion}
                    disabled={aiLoading}
                  >
                    {aiLoading ? 'Gettingâ€¦' : 'Get AI Suggestion'}
                  </Button>
                </div>
                {errors.price && <p className="text-red-500 text-sm">{errors.price}</p>}
              </div>

              <Checkbox
                name="negotiable"
                checked={formData.negotiable}
                onChange={handleInputChange}
                label="Negotiable"
              />
            </div>

            {/* Images (after price) */}
            <div>
              <label className="block text-sm font-semibold text-blue-900 dark:text-white">Images</label>
              <ImageUpload onChange={handleImageUpload} ref={fileInputRef} multiple accept="image/*" />
              {errors.images && <p className="text-red-500 text-sm">{errors.images}</p>}
              <div className="grid grid-cols-3 gap-4 mt-4">
                {images.map((img, index) => (
                  <div key={index} className="relative">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img
                      src={img.preview}
                      alt="Preview"
                      className="w-full h-32 object-cover rounded-md shadow-md"
                    />
                    <button
                      type="button"
                      onClick={() => removeImage(index)}
                      className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1"
                    >
                      âœ•
                    </button>
                  </div>
                ))}
              </div>
            </div>

            {/* Buttons */}
            <div className="flex gap-4 justify-end">
              <Button type="submit" variant="primary" disabled={isSubmitting} className="px-6 py-3 text-lg">
                {isSubmitting ? 'Creatingâ€¦' : 'Create Listing'}
              </Button>
              <Button type="button" variant="secondary" onClick={() => router.push('/browse')} disabled={isSubmitting} className="px-6 py-3 text-lg">
                Cancel
              </Button>
            </div>
          </form>
        </div>
      </motion.div>

      <style jsx>{`
        .animate-gradient { background-size: 300% 300%; animation: gradientShift 18s ease infinite; }
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `}</style>
    </div>
  );
}



================================================
File: app/favorites/page.js
================================================
// File: src/app/favorites/page.js
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import ListingCard from "@/app/components/ListingCard";
import { apiFetch } from "@/lib/api";

export default function FavoritesPage() {
  const [favorites, setFavorites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [needLogin, setNeedLogin] = useState(false);
  const [error, setError] = useState("");

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError("");

      const token =
        typeof window !== "undefined" ? localStorage.getItem("token") : null;
      if (!token) {
        setNeedLogin(true);
        setLoading(false);
        return;
      }

      try {
        // GET /api/v1/favorites/  (apiFetch must attach Authorization)
        const favs = await apiFetch("/favorites/");

        if (!Array.isArray(favs) || favs.length === 0) {
          setFavorites([]);
        } else {
          // Fetch listing details in parallel
          const ids = [...new Set(favs.map(f => f.listing_id).filter(Boolean))];
          const results = await Promise.all(
            ids.map(id => apiFetch(`/listings/${id}`).catch(() => null))
          );
          setFavorites(results.filter(Boolean));
        }
      } catch (e) {
        const msg = typeof e?.message === "string" ? e.message : "Failed to load favorites";
        if (msg.includes("401") || msg.toLowerCase().includes("unauthorized")) {
          setNeedLogin(true);
        } else {
          setError(msg);
        }
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  if (loading) return <p className="text-center">Loading your favorites...</p>;

  if (needLogin) {
    return (
      <p className="text-center text-gray-500">
        Please{" "}
        <Link className="underline" href="/auth/login">
          log in
        </Link>{" "}
        to view your favorites.
      </p>
    );
  }

  if (error) return <p className="text-center text-red-500">Error: {error}</p>;

  if (!favorites || favorites.length === 0) {
    return <p className="text-center text-gray-500">No favorites yet. Add items to your wishlist!</p>;
  }

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">My Favorites</h1>
      <div className="grid gap-4 md:grid-cols-3">
        {favorites.map(listing => (
          <ListingCard key={listing.id} listing={listing} showFavoriteToggle />
        ))}
      </div>
    </div>
  );
}



================================================
File: app/listing/[id]/page.js
================================================
// src/app/listings/[id]/page.js
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { apiFetch, toImageUrl } from '@/lib/api';
import { ensureRoomWithSeller } from '@/lib/chat'; // ← helper that creates/gets a room
import { Button } from '@/app/components/Button';   // optional (use a plain <button> if you prefer)

export default function ListingDetail() {
  const router = useRouter();
  const { id } = useParams();

  const [data, setData] = useState(null);
  const [seller, setSeller] = useState(null);
  const [err, setErr] = useState('');
  const [loading, setLoading] = useState(true);

  // button-local state
  const [startingChat, setStartingChat] = useState(false);
  const [chatErr, setChatErr] = useState('');

  useEffect(() => {
    let cancelled = false;

    async function load() {
      setLoading(true);
      setErr('');
      try {
        // GET /api/v1/listings/:id
        const res = await apiFetch(`/listings/${id}`);
        if (cancelled) return;
        setData(res || null);

        // Try to load seller profile if the payload exposes an id/email
        const sellerId = res?.seller_id ?? res?.owner_id ?? res?.user_id ?? null;
        if (sellerId) {
          try {
            const s = await apiFetch(`/users/${sellerId}`).catch(() => null);
            if (!cancelled && s) setSeller(s);
          } catch {
            /* ignore */
          }
        }
      } catch (e) {
        if (!cancelled) setErr(e?.message || 'Failed to fetch listing');
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    if (id) load();
    return () => {
      cancelled = true;
    };
  }, [id]);

  async function startChat() {
    setChatErr('');
    setStartingChat(true);
    try {
      const token =
        typeof window !== 'undefined' ? localStorage.getItem('token') : null;
      if (!token) {
        router.push('/auth/login');
        return;
      }

      const sellerUserId =
        data?.seller_id ?? data?.owner_id ?? data?.user_id ?? null;
      if (!sellerUserId) {
        setChatErr('Cannot determine seller for this listing.');
        return;
      }

      const room = await ensureRoomWithSeller({
        sellerUserId,
        listingId: data?.id || id,
      });

      const roomId = room?.id || room?.room_id;
      if (!roomId) {
        setChatErr('Could not open chat room.');
        return;
      }

      router.push(`/chat?room=${encodeURIComponent(roomId)}`);
    } catch (e) {
      setChatErr(String(e?.message || 'Could not start chat'));
    } finally {
      setStartingChat(false);
    }
  }

  if (loading) return <div className="p-6">Loading listing…</div>;
  if (err) return <div className="p-6 text-red-500">Error: {err}</div>;
  if (!data) return <div className="p-6">Listing not found.</div>;

  const images = Array.isArray(data.images)
    ? data.images
    : data.image
    ? [data.image]
    : [];
  const cover = images.length ? toImageUrl(images[0]) : '/placeholder.png';
  const price =
    typeof Intl !== 'undefined'
      ? new Intl.NumberFormat('en-PK', {
          style: 'currency',
          currency: 'PKR',
          maximumFractionDigits: 0,
        }).format(Number(data.price ?? 0))
      : `Rs ${Number(data.price ?? 0).toLocaleString('en-PK')}`;

  return (
    <div className="max-w-5xl mx-auto p-6 space-y-6">
      {/* header */}
      <div className="flex flex-col md:flex-row gap-6">
        <div className="relative w-full md:w-[460px] h-[280px] md:h-[340px] rounded-lg overflow-hidden bg-black/5">
          <Image
            src={cover}
            alt={data.title || 'Listing image'}
            fill
            className="object-cover"
            unoptimized
            sizes="(max-width:768px) 100vw, 460px"
          />
        </div>

        <div className="flex-1 space-y-2">
          <h1 className="text-2xl font-bold">{data.title}</h1>
          <div className="text-gray-500">Category: {data.category || '—'}</div>
          <div className="text-2xl font-extrabold text-blue-600">{price}</div>

          {/* seller capsule */}
          <div className="mt-4 rounded-lg border border-gray-200/40 dark:border-gray-700 p-4">
            <div className="text-sm text-gray-500">Seller</div>
            <div className="font-medium">
              {seller?.name ||
                data?.seller_name ||
                data?.owner_name ||
                'Seller'}
            </div>
            <div className="text-sm text-gray-500">
              {seller?.email || data?.seller_email || ''}
            </div>
          </div>

          {/* CTAs */}
          <div className="flex flex-wrap gap-3 pt-2">
            <Button
              variant="primary"
              onClick={startChat}
              disabled={startingChat}
              className="px-4 py-2"
            >
              {startingChat ? 'Starting…' : 'Message Seller'}
            </Button>

            {/* Anchor so any card “Buy” button can jump here if you scroll */}
            <a id="buy" />

            {/* For now, Buy → open chat as well (you can replace with a real flow later) */}
            <Button
              onClick={startChat}
              disabled={startingChat}
              className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md"
            >
              {startingChat ? 'Opening…' : 'Buy / Make Offer'}
            </Button>
          </div>

          {chatErr && <p className="text-red-500 text-sm">{chatErr}</p>}
        </div>
      </div>

      {/* description */}
      <div className="prose prose-invert max-w-none">
        <h2 className="text-xl font-semibold mb-2">Description</h2>
        <p className="leading-7 whitespace-pre-wrap">
          {data.description || 'No description.'}
        </p>
      </div>

      {/* Optional: link back to browse */}
      <div>
        <Link href="/browse" className="text-blue-400 underline">
          ← Back to listings
        </Link>
      </div>
    </div>
  );
}



================================================
File: app/my-listings/page.js
================================================
// File: src/app/my-listings/page.js
'use client';
import { useEffect, useState } from 'react';
import Link from 'next/link';
import ListingCard from '@/app/components/ListingCard';
import { apiFetch } from '@/lib/api';

const toViewModel = (item) => ({
  ...item,
  image:
    (Array.isArray(item.images) && item.images[0]) ||
    item.image ||
    'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCBmaWxsPSIjMTgxODIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIi8+PHRleHQgeD0iNTAiIHk9IjE1MCIgZmlsbD0iI2JiYiIgc3R5bGU9ImZvbnQ6IDE2cHggL2ludGVyOyI+Tm8gaW1hZ2U8L3RleHQ+PC9zdmc+',
});

export default function MyListingsPage() {
  const [listings, setListings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('active');
  const [needLogin, setNeedLogin] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError('');

      const token =
        typeof window !== 'undefined' ? localStorage.getItem('token') : null;
      if (!token) {
        setNeedLogin(true);
        setLoading(false);
        return;
      }

      try {
        // get current user
        const me = await apiFetch('/auth/me');

        // If your backend supports filtering: `/listings?owner_id=${me.id}`
        // Otherwise, fetch all and filter client-side:
        const data = await apiFetch('/listings');
        const all = Array.isArray(data) ? data : data.items || data.listings || [];
        const mine = all.filter((x) => String(x.owner_id ?? x.user_id) === String(me?.id));

        setListings(mine.map(toViewModel));
      } catch (e) {
        const msg =
          typeof e === 'string'
            ? e
            : e?.message || e?.detail || 'Failed to load your listings';
        if (/401|unauthorized/i.test(String(msg))) {
          setNeedLogin(true);
        } else {
          setError(msg);
        }
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  if (loading) return <p className="text-center">Loading your listings...</p>;

  if (needLogin)
    return (
      <p className="text-center text-gray-500">
        Please <Link href="/auth/login" className="underline">log in</Link> to view your listings.
      </p>
    );

  if (error) return <p className="text-center text-red-500">{String(error)}</p>;

  if (!listings.length)
    return <p className="text-center text-gray-500">You havenâ€™t posted any listings yet.</p>;

  const Active = listings.filter((i) => i.status === 'active' || i.status === 'ACTIVE' || !i.status);
  const Sold = listings.filter((i) => i.status === 'sold' || i.status === 'SOLD');

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">My Listings</h1>

      <div className="flex gap-4 border-b">
        <button
          onClick={() => setActiveTab('active')}
          className={`px-4 py-2 border-b-2 ${activeTab === 'active' ? 'border-blue-500 font-semibold' : 'border-transparent text-gray-500'}`}
        >
          Active
        </button>
        <button
          onClick={() => setActiveTab('sold')}
          className={`px-4 py-2 border-b-2 ${activeTab === 'sold' ? 'border-blue-500 font-semibold' : 'border-transparent text-gray-500'}`}
        >
          Sold
        </button>
      </div>

      {activeTab === 'active' && (
        <div className="grid gap-4 md:grid-cols-3">
          {Active.map((item) => (
            <ListingCard key={item.id} listing={item} />
          ))}
        </div>
      )}

      {activeTab === 'sold' && (
        <div className="grid gap-4 md:grid-cols-3">
          {Sold.map((item) => (
            <ListingCard key={item.id} listing={item} />
          ))}
        </div>
      )}
    </div>
  );
}



================================================
File: app/notifications/page.js
================================================
// File: src/app/notifications/page.js
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { Bell, MessageSquare, CheckCircle, Tag } from "lucide-react";
import { apiFetch } from "@/lib/api";

export default function NotificationsPage() {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);
  const [needLogin, setNeedLogin] = useState(false);
  const [error, setError] = useState("");

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError("");

      // require auth
      const token =
        typeof window !== "undefined" ? localStorage.getItem("token") : null;
      if (!token) {
        setNeedLogin(true);
        setLoading(false);
        return;
      }

      try {
        // GET /api/v1/notifications?skip=&limit=&unread_only=
        const params = new URLSearchParams({
          skip: "0",
          limit: "50",
          unread_only: "false",
        });
        const data = await apiFetch(`/notifications?${params.toString()}`);

        setNotifications(Array.isArray(data) ? data : []);
      } catch (e) {
        const msg = e?.message || "Failed to fetch notifications";
        if (msg.includes("401") || msg.toLowerCase().includes("unauthorized")) {
          setNeedLogin(true);
        } else {
          setError(msg);
        }
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  if (loading) return <p className="text-center">Loading notifications...</p>;

  if (needLogin)
    return (
      <p className="text-center text-gray-500">
        Please{" "}
        <Link href="/auth/login" className="underline">
          log in
        </Link>{" "}
        to view notifications.
      </p>
    );

  if (error) return <p className="text-center text-red-500">{error}</p>;

  if (!notifications.length)
    return <p className="text-center text-gray-500">No notifications yet.</p>;

  const iconMap = {
    message: <MessageSquare className="w-5 h-5 text-blue-500" />,
    offer: <Tag className="w-5 h-5 text-green-500" />,
    verification: <CheckCircle className="w-5 h-5 text-purple-500" />,
  };

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Notifications</h1>
      <ul className="divide-y divide-gray-200 dark:divide-gray-700">
        {notifications.map((n) => (
          <li key={n.id} className="flex items-center gap-3 py-3">
            {iconMap[n.type] || <Bell className="w-5 h-5 text-gray-500" />}
            <div>
              <p className="font-medium">{n.title || n.type}</p>
              <p className="text-sm text-gray-500">{n.message}</p>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
}



================================================
File: app/profile/page.js
================================================
'use client';

import { useEffect, useState } from 'react';
import { apiFetch } from '@/lib/api';

export default function ProfilePage() {
  const [me, setMe] = useState(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState('');

  useEffect(() => {
    async function load() {
      try {
        const data = await apiFetch('/auth/me', { cache: 'no-store' });
        setMe(data || null);
      } catch (e) {
        setErr('Failed to load profile');
      } finally {
        setLoading(false);
      }
    }
    load();
  }, []);

  if (loading) return <p className="p-6">Loading profileâ€¦</p>;
  if (err) return <p className="p-6 text-red-500">{err}</p>;
  if (!me) return <p className="p-6">No profile found. Please login again.</p>;

  return (
    <div className="max-w-2xl mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold">Profile</h1>

      <div className="rounded-lg border border-gray-200 dark:border-gray-700 p-6 space-y-3 bg-white dark:bg-gray-800 shadow">
        <div>
          <p className="text-gray-500 text-sm">Name</p>
          <p className="font-medium">{me.name || 'â€”'}</p>
        </div>

        <div>
          <p className="text-gray-500 text-sm">Email</p>
          <p className="font-medium">{me.email}</p>
        </div>

        <div>
          <p className="text-gray-500 text-sm">User ID</p>
          <p className="font-mono text-sm">{me.id || me.user_id || 'â€”'}</p>
        </div>

        {me.role && (
          <div>
            <p className="text-gray-500 text-sm">Role</p>
            <p className="font-medium">{me.role}</p>
          </div>
        )}
      </div>
    </div>
  );
}



================================================
File: app/ui/page.js
================================================
// File: uni-market/src/app/ui/page.js
import { Button } from '../components/Button';
import { Input } from '../components/Input';
import { Skeleton } from '../components/Skeleton';
import { Spinner } from '../components/Spinner';
import { EmptyState } from '../components/EmptyState';

export default function UIPage() {
  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold">UI Kit</h2>
      
      <section className="space-y-4">
        <h3 className="text-xl font-semibold">Buttons</h3>
        <div className="flex space-x-4">
          <Button variant="primary">Primary Button</Button>
          <Button variant="secondary">Secondary Button</Button>
          <Button variant="destructive">Destructive Button</Button>
          <Button disabled>Disabled Button</Button>
        </div>
      </section>

      <section className="space-y-4">
        <h3 className="text-xl font-semibold">Inputs</h3>
        <div className="space-y-2 max-w-md">
          <Input type="text" placeholder="Enter text" />
          <Input type="email" placeholder="Enter email" />
          <Input type="text" placeholder="Disabled input" disabled />
        </div>
      </section>

      <section className="space-y-4">
        <h3 className="text-xl font-semibold">Skeletons</h3>
        <div className="space-y-2">
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-3/4" />
          <Skeleton className="h-4 w-1/2" />
        </div>
      </section>

      <section className="space-y-4">
        <h3 className="text-xl font-semibold">Spinner</h3>
        <Spinner />
      </section>

      <section className="space-y-4">
        <h3 className="text-xl font-semibold">Empty State</h3>
        <EmptyState
          title="No Items Found"
          description="It looks like there are no items available in the marketplace yet."
          action={<Button variant="primary">Add Item</Button>}
        />
      </section>
    </div>
  );
}


================================================
File: lib/api.ts
================================================
// Always call same-origin /api/v1/* (handled by our server-side proxy).
const RELATIVE_BASE = '/api/v1';

function joinUrl(base: string, path: string) {
  const b = base.replace(/\/+$/, '');
  const p = path.startsWith('/') ? path : `/${path}`;
  return `${b}${p}`;
}
function sameOriginBase() {
  const origin =
    typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
  return joinUrl(origin, RELATIVE_BASE);
}

async function fetchWithTimeout(url: string, init: RequestInit, ms = 120000) { // 120s default
  const controller = typeof AbortController !== 'undefined' ? new AbortController() : null;
  const id = setTimeout(() => controller?.abort(), ms);
  try {
    return await fetch(url, { ...init, signal: controller?.signal, cache: 'no-store' });
  } finally {
    clearTimeout(id);
  }
}

// allow callers to override timeout via init.timeoutMs
type ApiInit = RequestInit & { timeoutMs?: number };

export async function apiFetch(path: string, init: ApiInit = {}) {
  const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
  const tokenType =
    typeof window !== 'undefined' ? localStorage.getItem('token_type') || 'Bearer' : 'Bearer';

  const headers = new Headers(init.headers || {});
  const isForm = typeof FormData !== 'undefined' && init.body instanceof FormData;

  if (!isForm && !headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
  if (token && !headers.has('Authorization')) headers.set('Authorization', `${tokenType} ${token}`);

  const url = joinUrl(sameOriginBase(), path);

  // pull out timeoutMs (fallback to 120s if not provided)
  const { timeoutMs, ...rest } = init;
  const ms = typeof timeoutMs === 'number' ? timeoutMs : 120000;

  let res: Response;
  try {
    res = await fetchWithTimeout(url, { ...rest, headers }, ms);
  } catch (e: any) {
    throw new Error(`Network error while calling ${url}: ${e?.message || 'Failed to fetch'}`);
  }

  const text = await res.text();
  const data = text ? (() => { try { return JSON.parse(text); } catch { return text; } })() : null;

  if (!res.ok) {
    // surface backend error text (string) or JSON .detail/.message when present
    let msg =
      (data && (typeof data === 'object' ? (data as any).detail || (data as any).message : undefined)) ||
      (typeof data === 'string' && data.trim().length ? data : `${res.status} ${res.statusText}`);
    if (typeof msg === 'object') { try { msg = JSON.stringify(msg); } catch {} }
    throw new Error(msg as string);
  }
  return data;
}

export function toImageUrl(url?: string) {
  if (!url) return '';
  if (/^https?:\/\//i.test(url)) return url;
  return url.startsWith('/') ? url : `/${url}`;
}



================================================
File: lib/chat.js
================================================
// src/lib/chat.js
import { apiFetch } from './api';

/**
 * Try to find (and, if backend supports it, create) a chat room
 * with the seller for a given listing.
 *
 * If your backend does not support creating rooms yet, this will:
 *  - return the existing room if found
 *  - otherwise throw an error explaining the server limitation
 */
export async function ensureRoomWithSeller({ sellerUserId, listingId }) {
  if (!sellerUserId) throw new Error('Missing sellerUserId');

  // 1) Look through existing rooms
  let rooms = [];
  try {
    const res = await apiFetch('/chat/rooms', { cache: 'no-store' });
    if (Array.isArray(res)) rooms = res;
  } catch (e) {
    // If we can't even list rooms, surface that error.
    throw new Error(e?.message || 'Failed to load chat rooms');
  }

  const match = rooms.find((r) => {
    const rListing = String(r.listing_id ?? '');
    const rP1 = String(r.participant1_id ?? '');
    const rP2 = String(r.participant2_id ?? '');
    const sId = String(sellerUserId ?? '');
    const byListing = listingId ? String(listingId) === rListing : true;
    const hasSeller = rP1 === sId || rP2 === sId;
    return byListing && hasSeller;
  });

  if (match) return match;

  // 2) No room found. Try to create (if your backend supports it).
  //    If your server still has only GET /chat/rooms, this will return 405.
  try {
    const created = await apiFetch('/chat/rooms', {
      method: 'POST',
      body: JSON.stringify({
        // Adjust keys to whatever your backend expects
        participant_id: sellerUserId,
        listing_id: listingId,
      }),
    });
    return created;
  } catch (e) {
    const msg = String(e?.message || '');
    if (msg.includes('405') || /Method Not Allowed/i.test(msg) || msg.includes('404')) {
      // Clear explanation for the UI
      throw new Error(
        'Method Not Allowed — your backend does not support creating chat rooms yet. ' +
          'Ask the server to add a POST /api/v1/chat/rooms or a “start chat” endpoint.'
      );
    }
    throw e;
  }
}



================================================
File: utils/format.js
================================================
// src/utils/format.js

// Format a number into PKR currency string
export function formatPKR(amount) {
  if (typeof amount !== "number") {
    amount = Number(amount);
    if (isNaN(amount)) return "Rs 0";
  }
  return new Intl.NumberFormat("en-PK", {
    style: "currency",
    currency: "PKR",
    minimumFractionDigits: 0,
  }).format(amount);
}


